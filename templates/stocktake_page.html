<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stocktake</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>

<body
  data-engineer="{{ engineer_email }}"
  data-submitted="{{ '1' if submitted else '0' }}"
  data-set-url-template="{{ url_for('stocktake_set_item_qty', engineer_email=engineer_email, part_number='__PN__') }}"
  data-counts-url="{{ url_for('stocktake_counts_api', engineer_email=engineer_email) }}"
>

<header class="sticky-top stocktake-header">
  <div class="container-fluid">

    <!-- Run name row -->
    <div class="py-2 border-bottom">
      <div class="d-flex justify-content-between align-items-center gap-2">
        <span class="text-muted small">Name of Stock Take:</span>
        <div class="fw-semibold">{{ run_name }}</div>
      </div>
    </div>

    <!-- Top row: Home | Title | Review & Submit -->
    <div class="d-flex justify-content-between align-items-center gap-2 py-2">
      <a href="{{ url_for('landing') }}" class="btn btn-outline-secondary btn-sm">Home</a>

      <div class="text-center flex-grow-1">
        <div class="fw-semibold">Stocktake</div>
        <div class="small text-muted">
          {{ engineer_email }}
          {% if submitted %}
            · Submitted: {{ submitted_at }}
          {% else %}
            · In progress
          {% endif %}
        </div>
      </div>

      <a href="{{ url_for('stocktake_review', engineer_email=engineer_email) }}"
         class="btn btn-dark btn-sm">
        Review &amp; Submit
      </a>
    </div>

    <!-- View toggle -->
    <div class="d-flex justify-content-between align-items-center gap-2 pb-2">
      <div class="btn-group" role="group" aria-label="Stocktake view">
        <button type="button" class="btn btn-outline-primary active" id="viewAllBtn">All Parts</button>
        <button type="button" class="btn btn-outline-primary" id="viewMineBtn">
          Stocktake
        </button>
      </div>
    </div>

    {% if submitted %}
      <div class="alert alert-success py-2 mb-2">
        This stocktake is locked (submitted on <strong>{{ submitted_at }}</strong>).
      </div>
    {% endif %}

    <!-- Filters row -->
    <form method="get" class="d-flex flex-nowrap gap-2 pb-2" id="stocktakeFilters">
      <input
        id="stSearch"
        type="text"
        name="search"
        value="{{ search }}"
        placeholder="Search parts..."
        class="form-control"
        autocomplete="off"
      >
      <select id="stCategory" name="category" class="form-select" style="max-width: 190px;">
        <option value="">All</option>
        {% for c in categories %}
          <option value="{{ c }}" {% if c == selected_category %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="btn btn-primary" id="stSearchBtn">Search</button>
    </form>

  </div>
</header>

<div class="container mt-3 mb-5">

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} mb-3">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Empty state for "My Stocktake" view -->
  <div id="mineEmpty" class="text-muted text-center py-4" style="display:none;">
    No items selected yet. Tap + on parts to add them.
  </div>

  {% if parts %}
    <div class="row g-3" id="stocktakeCardsGrid">
      {% for part in parts %}
        {% set current_qty = item_qty_map.get(part.part_number, 0) if item_qty_map is defined else 0 %}

        <div class="col-12 col-md-6">
          <div class="card h-100 stocktake-part-card"
               data-part="{{ part.part_number }}"
               data-desc="{{ part.description|e }}">

            <div class="card-body d-flex flex-column">

              <div class="d-flex justify-content-between align-items-start gap-2">
                <div>
                  <div class="fw-semibold">{{ part.part_number }}</div>
                  <div class="text-muted small st-desc">{{ part.description }}</div>
                </div>

                {% if submitted %}
                  <span class="badge bg-secondary">Locked</span>
                {% else %}

                {% endif %}
              </div>

              <div class="mt-3">
                {% if submitted %}
                  <input class="form-control text-center" value="{{ current_qty }}" disabled>
                {% else %}
                  <div class="d-flex justify-content-center align-items-center gap-2">
                    <button type="button" class="btn btn-outline-secondary st-minus" aria-label="Decrease">−</button>

                    <input
                      type="number"
                      min="0"
                      value="{{ current_qty }}"
                      class="form-control text-center st-qty"
                      inputmode="numeric"
                      aria-label="Quantity"
                    >

                    <button type="button" class="btn btn-outline-secondary st-plus" aria-label="Increase">+</button>
                  </div>

                  <div class="small text-muted text-center mt-2 st-status"></div>
                {% endif %}
              </div>

            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">No parts found. Try a different search.</p>
  {% endif %}
</div>

<!-- Bottom toast -->
<div id="stToast" class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999; display:none;">
  <div class="toast align-items-center text-bg-success border-0 show">
    <div class="d-flex">
      <div class="toast-body" id="stToastMsg">Saved</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" id="stToastClose"></button>
    </div>
  </div>
<script>
  // Simple remote count: keeps the "My Stocktake" badge in sync with the server.
  (function () {
    const body = document.body;
    const url = body.dataset.countsUrl;
    const badge = document.getElementById('mineCountBadge');
    if (!url || !badge) return;

    async function refreshCounts() {
      try {
        const res = await fetch(url, { cache: 'no-store' });
        const data = await res.json();
        if (!data || data.ok !== true) return;

        // "items in the box" = total quantity across all selected parts
        badge.textContent = String(data.total_qty ?? data.total_qty === 0 ? data.total_qty : (data.total_qty || 0));
      } catch (e) {
        // silent
      }
    }

    refreshCounts();
    setInterval(refreshCounts, 2500);
  })();
</script>

</body>
</html>
