<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stocktake Admin - Edit</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>

<body
  data-stocktake-id="{{ stocktake_id }}"
  data-leader-set-url-template="{{ url_for('stocktake_leader_set_item_qty', stocktake_id=stocktake_id, part_number='__PN__') }}"
>

<header class="sticky-top stocktake-header">
  <div class="container-fluid">

    <!-- Run name row -->
    <div class="py-2 border-bottom">
      <div class="d-flex justify-content-between align-items-center gap-2">
        <span class="text-muted small">Name of Stock Take:</span>
        <div class="fw-semibold">{{ run_name }}</div>
      </div>
    </div>

    <!-- Top row: Back | Title | Export -->
    <div class="d-flex justify-content-between align-items-center gap-2 py-2">
      <a href="{{ url_for('stocktake_leader_dashboard') }}" class="btn btn-outline-secondary btn-sm">Back</a>

      <div class="text-center flex-grow-1">
        <div class="fw-semibold">Admin Edit</div>
        <div class="small text-muted">
          {{ engineer_email }}
          {% if status == 'checked' and checked_at %}
            · Checked: {{ checked_at }}{% if checked_by %} by {{ checked_by }}{% endif %}
          {% elif submitted_at and submitted_at != '—' %}
            · Submitted: {{ submitted_at }}
          {% else %}
            · Pending
          {% endif %}
        </div>
      </div>

      <a href="{{ url_for('stocktake_leader_export_engineer', stocktake_id=stocktake_id) }}"
         class="btn btn-dark btn-sm">
        Export CSV
      </a>
    </div>

    <!-- View toggle -->
    <div class="d-flex justify-content-between align-items-center gap-2 pb-2">
      <div class="btn-group" role="group" aria-label="Stocktake view">
        <button type="button" class="btn btn-outline-primary active" id="leadViewAllBtn">All Parts</button>
        <button type="button" class="btn btn-outline-primary" id="leadViewMineBtn">
          Stocktake
        </button>
      </div>
    </div>

    <!-- Filters row -->
    <form method="get" class="d-flex flex-nowrap gap-2 pb-2" id="leadStocktakeFilters">
      <input
        id="leadSearch"
        type="text"
        name="search"
        value="{{ search }}"
        placeholder="Search parts..."
        class="form-control"
        autocomplete="off"
      >
      <select id="leadCategory" name="category" class="form-select" style="max-width: 190px;">
        <option value="">All</option>
        {% for c in categories %}
          <option value="{{ c }}" {% if c == selected_category %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="btn btn-primary" id="leadSearchBtn">Search</button>
    </form>

  </div>
</header>

<div class="container mt-3 mb-5">

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} mb-3">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Empty state for "My Stocktake" view -->
  <div id="leadMineEmpty" class="text-muted text-center py-4" style="display:none;">
    No items selected yet. Tap + on parts to add them.
  </div>

  {% if parts %}
    <div class="row g-3" id="leadCardsGrid">
      {% for part in parts %}
        {% set current_qty = item_qty_map.get(part.part_number, 0) if item_qty_map is defined else 0 %}

        <div class="col-12 col-md-6">
          <div class="card h-100 leader-part-card"
               data-part="{{ part.part_number }}"
               data-desc="{{ part.description|e }}">

            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <div>
                  <div class="fw-semibold">{{ part.part_number }}</div>
                  <div class="text-muted small st-desc">{{ part.description }}</div>
                </div>
              </div>

              <div class="mt-3">
                <div class="d-flex justify-content-center align-items-center gap-2">
                  <button type="button" class="btn btn-outline-secondary lead-minus" aria-label="Decrease">−</button>

                  <input
                    type="number"
                    min="0"
                    value="{{ current_qty }}"
                    class="form-control text-center lead-qty"
                    inputmode="numeric"
                    aria-label="Quantity"
                  >

                  <button type="button" class="btn btn-outline-secondary lead-plus" aria-label="Increase">+</button>
                </div>

                <div class="small text-muted text-center mt-2 lead-status"></div>
              </div>
            </div>

          </div>
        </div>

      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">No parts found. Try a different search.</p>
  {% endif %}

  <!-- Admin review (sign-off) -->
  <div class="card shadow-sm border-0 rounded-4 mt-4">
    <div class="card-body">
      <h5 class="mb-2">Reviewed</h5>
      {% if status == 'checked' and checked_at %}
        <div class="alert alert-success mb-3">
          This stocktake is <strong>REVIEWED</strong>
          {% if checked_by %} by <strong>{{ checked_by }}</strong>{% endif %}
          on <strong>{{ checked_at }}</strong>.
        </div>
      {% else %}
        <p class="text-muted mb-3">
          When you've reviewed this stocktake, enter your name and mark it as reviewed.
        </p>
        <form method="POST" action="{{ url_for('stocktake_leader_check', stocktake_id=stocktake_id) }}" class="row g-2 align-items-end">
          <div class="col-12 col-md-8">
            <label class="form-label">Reviewed by</label>
            <input name="checked_by" class="form-control" placeholder="Your name" required>
          </div>
          <div class="col-12 col-md-4">
            <button class="btn btn-success w-100"
                    onclick="return confirm('Mark this stocktake as REVIEWED?');">
              Mark as Reviewed
            </button>
          </div>
        </form>
        <div class="small text-muted mt-2">
          Status colours: <span class="badge bg-danger">Pending</span>
          <span class="badge bg-warning text-dark">Submitted</span>
          <span class="badge bg-success">Checked</span>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Bottom toast -->
<div id="leadToast" class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999; display:none;">
  <div class="toast align-items-center text-bg-success border-0 show">
    <div class="d-flex">
      <div class="toast-body" id="leadToastMsg">Saved</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" id="leadToastClose"></button>
    </div>
  </div>
</div>

</body>
</html>
